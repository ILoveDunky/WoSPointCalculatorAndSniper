<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Whiteout Survival - Event Calculator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #1a1a2e;
            --bg-tertiary: #16213e;
            --accent-blue: #0f4c75;
            --bright-blue: #3282b8;
            --text-primary: #ffffff;
            --text-secondary: #b8c5d6;
            --border-color: #2a3f5f;
            --success: #2196f3;
            --warning: #3282b8;
            --gradient: linear-gradient(135deg, #0f4c75, #3282b8);
            --gold: #ffd700;
            --ice-blue: #87ceeb;
        }

        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px;
            background: var(--gradient);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(15, 76, 117, 0.3);
            position: relative;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .donation-note {
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid var(--gold);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            text-align: center;
        }

        .donation-note .gold-text {
            color: var(--gold);
            font-weight: bold;
        }

        .event-selector {
            margin-bottom: 30px;
        }

        .event-tabs {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 20px;
        }

        .event-tab {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            color: var(--text-secondary);
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .event-tab:hover {
            border-color: var(--bright-blue);
            color: var(--text-primary);
        }

        .event-tab.active {
            background: var(--gradient);
            border-color: var(--bright-blue);
            color: var(--text-primary);
            box-shadow: 0 4px 15px rgba(50, 130, 184, 0.3);
        }

        .calculator-section {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid var(--border-color);
        }

        .section-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: var(--bright-blue);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .main-toggles {
            display: flex;
            align-items: center;
            gap: 30px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .toggle-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toggle {
            position: relative;
            width: 50px;
            height: 26px;
            background: var(--bg-tertiary);
            border-radius: 13px;
            cursor: pointer;
            transition: background 0.3s ease;
            border: 1px solid var(--border-color);
        }

        .toggle.active {
            background: var(--bright-blue);
        }

        .toggle::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
        }

        .toggle.active::after {
            transform: translateX(24px);
        }

        .advanced-options {
            background: var(--bg-tertiary);
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            overflow: hidden;
        }

        .advanced-header {
            padding: 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.3s ease;
        }

        .advanced-header:hover {
            background: rgba(50, 130, 184, 0.1);
        }

        .advanced-content {
            padding: 15px;
            border-top: 1px solid var(--border-color);
            display: none;
        }

        .advanced-content.active {
            display: block;
        }

        .advanced-toggles {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .item-card {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 15px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .item-card:hover {
            border-color: var(--bright-blue);
            box-shadow: 0 4px 15px rgba(50, 130, 184, 0.2);
        }

        .item-card.disabled {
            opacity: 0.5;
            pointer-events: none;
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .item-name {
            font-weight: 600;
            color: var(--text-primary);
        }

        .item-points {
            color: var(--bright-blue);
            font-weight: bold;
            font-size: 0.9rem;
        }

        .item-input {
            width: 100%;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 1rem;
        }

        .item-input:focus {
            outline: none;
            border-color: var(--bright-blue);
            box-shadow: 0 0 0 2px rgba(50, 130, 184, 0.2);
        }

        .troop-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }

        .troop-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .input-label {
            color: var(--text-secondary);
            font-weight: 500;
        }

        .instructions {
            background: var(--bg-tertiary);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border-left: 4px solid var(--ice-blue);
        }

        .instructions h4 {
            color: var(--ice-blue);
            margin-bottom: 8px;
        }

        .instructions ol {
            color: var(--text-secondary);
            padding-left: 20px;
        }

        .instructions li {
            margin-bottom: 5px;
        }

        .summary {
            background: var(--gradient);
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            margin-top: 30px;
            box-shadow: 0 8px 32px rgba(15, 76, 117, 0.3);
        }

        .total-points {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
        }

        .sniping-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }

        .sniping-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .sniping-result {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            border-left: 4px solid var(--bright-blue);
        }

        .custom-event-section {
            margin-top: 30px;
            padding: 20px;
            background: var(--bg-tertiary);
            border-radius: 10px;
            border: 1px solid var(--border-color);
        }

        .custom-items-list {
            margin-top: 15px;
        }

        .custom-item {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px;
            background: var(--bg-secondary);
            border-radius: 6px;
        }

        .efficiency-badge {
            background: var(--bright-blue);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .efficiency-badge.medium {
            background: var(--ice-blue);
            color: var(--bg-primary);
        }

        .efficiency-badge.low {
            background: var(--accent-blue);
        }

        .delete-btn {
            background: var(--accent-blue);
            color: white;
            border: none;
            padding: 5px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .add-custom-btn {
            background: var(--bright-blue);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 10px;
        }

        .timer-section {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            border: 1px solid var(--border-color);
        }

        .timer-display {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--ice-blue);
            text-align: center;
            margin: 10px 0;
        }

        .progress-bar {
            background: var(--bg-primary);
            border-radius: 10px;
            height: 20px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            background: var(--gradient);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
        }

        .event-info {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 4px solid var(--gold);
        }

        .resource-tracker {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            border: 1px solid var(--border-color);
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .event-tabs {
                flex-direction: column;
            }
            
            .items-grid {
                grid-template-columns: 1fr;
            }
            
            .total-points {
                font-size: 2rem;
            }

            .main-toggles {
                gap: 15px;
            }
        }

        .tooltip {
            position: relative;
            cursor: help;
        }

        .tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-primary);
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            border: 1px solid var(--border-color);
            z-index: 100;
        }

        .tooltip:hover::after {
            opacity: 1;
        }

        .special-inputs {
            background: var(--bg-tertiary);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border: 1px solid var(--border-color);
        }

        .special-inputs h4 {
            color: var(--bright-blue);
            margin-bottom: 10px;
        }

        .chevron {
            transition: transform 0.3s ease;
        }

        .chevron.rotated {
            transform: rotate(180deg);
        }

        .points-history {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            border: 1px solid var(--border-color);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--bright-blue);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .export-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .export-btn {
            background: var(--accent-blue);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>‚öîÔ∏è Whiteout Survival Event Calculator</h1>
            <p>Optimize your resources and dominate the events</p>
            <div class="donation-note">
                <p>üéØ This tool is completely free! If it helps you dominate events, feel free to <span class="gold-text">Donate Froststars</span> in-game!</p>
                <p><span class="gold-text">Player ID: 176435188</span> üéÅ</p>
            </div>
        </header>

        <div class="event-selector">
            <div class="event-tabs">
                <div class="event-tab active" data-event="koi">üßä King of Icefield</div>
                <div class="event-tab" data-event="officer-essence">üßë‚Äç‚úàÔ∏è Officer - Essence</div>
                <div class="event-tab" data-event="officer-charm">üßë‚Äç‚úàÔ∏è Officer - Charm</div>
                <div class="event-tab" data-event="armament-tomes">üèπ Armament - Tomes</div>
                <div class="event-tab" data-event="armament-design">üèπ Armament - Design</div>
                <div class="event-tab" data-event="svs">üè¥‚Äç‚ò†Ô∏è State vs State</div>
                <div class="event-tab" data-event="custom">‚öôÔ∏è Custom Event</div>
            </div>
        </div>

        <div class="event-info" id="event-info">
            <p><strong>üí° How to determine your event:</strong> Go to Calendar ‚Üí Events tab ‚Üí Click on current event ‚Üí Check rewards to identify if it's Officer (Essence/Charm) or Armament (Tomes/Design Plan)</p>
        </div>

        <div class="calculator-section">
            <h2 class="section-title" id="section-title">üßä King of Icefield Calculator</h2>
            
            <div class="main-toggles">
                <div class="toggle-container">
                    <div class="toggle" id="sniping-toggle"></div>
                    <label>üéØ Sniping Calculator</label>
                </div>
                
                <div class="toggle-container" id="troops-toggle-container">
                    <div class="toggle" id="troops-toggle"></div>
                    <label>ü™ñ Troop Training</label>
                </div>

                <div class="toggle-container">
                    <div class="toggle" id="timer-toggle"></div>
                    <label>‚è∞ Event Timer</label>
                </div>

                <div class="toggle-container">
                    <div class="toggle" id="history-toggle"></div>
                    <label>üìä Points History</label>
                </div>
            </div>

            <div class="advanced-options" id="advanced-options">
                <div class="advanced-header" onclick="toggleAdvancedOptions()">
                    <span>‚öôÔ∏è Advanced Options & Toggles</span>
                    <span class="chevron">‚ñº</span>
                </div>
                <div class="advanced-content" id="advanced-content">
                    <div class="advanced-toggles" id="toggles-container"></div>
                </div>
            </div>

            <div id="timer-section" class="timer-section" style="display: none;">
                <h4 style="color: var(--bright-blue); margin-bottom: 10px;">‚è∞ Event Countdown</h4>
                <div class="timer-inputs">
                    <div class="input-group">
                        <label class="input-label">Event End Date & Time</label>
                        <input type="datetime-local" class="item-input" id="event-end-time">
                    </div>
                </div>
                <div class="timer-display" id="timer-display">Set event end time</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
            </div>

            <div id="history-section" class="points-history" style="display: none;">
                <h4 style="color: var(--bright-blue); margin-bottom: 10px;">üìä Points History</h4>
                <div class="export-buttons">
                    <button class="export-btn" onclick="exportData()">üì§ Export Data</button>
                    <button class="export-btn" onclick="importData()">üì• Import Data</button>
                    <button class="export-btn" onclick="clearHistory()">üóëÔ∏è Clear History</button>
                </div>
                <div id="history-content"></div>
            </div>

            <div id="custom-event-creator" class="custom-event-section" style="display: none;">
                <h3>Create Custom Event</h3>
                <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                    <input type="text" id="custom-event-name" placeholder="Event Name" class="item-input" style="flex: 1; min-width: 200px;">
                    <input type="text" id="custom-item-name" placeholder="Item Name" class="item-input" style="flex: 1; min-width: 150px;">
                    <input type="number" id="custom-item-points" placeholder="Points" class="item-input" style="width: 100px;">
                    <button class="add-custom-btn" onclick="addCustomItem()">Add Item</button>
                </div>
                <div class="custom-items-list" id="custom-items-list"></div>
                <button class="add-custom-btn" onclick="saveCustomEvent()" style="background: var(--bright-blue);">Save Event</button>
            </div>

            <div class="items-grid" id="items-container"></div>

            <div class="troop-section" id="troop-section" style="display: none;">
                <h3 class="section-title">ü™ñ Troop Training Calculator</h3>
                <div class="instructions">
                    <h4>üìã How to find your training time:</h4>
                    <ol>
                        <li>Go to your camp with the highest level troops</li>
                        <li>Click on "Train" button</li>
                        <li>Select your highest level troop</li>
                        <li>Set amount to <strong>1</strong> troop</li>
                        <li>Note the training time and enter it below in <strong>seconds</strong></li>
                        <li><em>Example: 30 minutes = 1800 seconds, 1 hour = 3600 seconds</em></li>
                    </ol>
                </div>
                <div class="troop-inputs">
                    <div class="input-group">
                        <label class="input-label">Highest Troop Level</label>
                        <select class="item-input" id="troop-level">
                            <option value="">Select Level</option>
                            <option value="1">Level 1</option>
                            <option value="2">Level 2</option>
                            <option value="3">Level 3</option>
                            <option value="4">Level 4</option>
                            <option value="5">Level 5</option>
                            <option value="6">Level 6</option>
                            <option value="7">Level 7</option>
                            <option value="8">Level 8</option>
                            <option value="9">Level 9</option>
                            <option value="10">Level 10</option>
                            <option value="11">Level 11</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label class="input-label">Time per 1 Troop (seconds)</label>
                        <input type="number" class="item-input" id="troop-time" placeholder="e.g. 1800 for 30min">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Available Speedups (seconds)</label>
                        <input type="number" class="item-input" id="troop-speedups" placeholder="Total seconds">
                    </div>
                </div>
                <div id="troop-calculation" style="margin-top: 15px;"></div>
            </div>

            <div id="special-calculations"></div>

            <div class="sniping-section" id="sniping-section" style="display: none;">
                <h3 class="section-title">üéØ Sniping Calculator</h3>
                <div class="sniping-inputs">
                    <div class="input-group">
                        <label class="input-label">Target Point Gap</label>
                        <input type="number" class="item-input" id="target-gap" placeholder="Enter points needed">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Min General Shards per Use</label>
                        <select class="item-input" id="min-shards">
                            <option value="1">Any Amount</option>
                            <option value="5">5 minimum</option>
                            <option value="10">10 minimum</option>
                            <option value="40">40 minimum</option>
                            <option value="100">100 minimum</option>
                        </select>
                    </div>
                </div>
                <div class="sniping-result" id="sniping-result"></div>
            </div>
        </div>

        <div class="summary">
            <div class="total-points" id="total-points">0</div>
            <p>Total Event Points</p>
        </div>

        <input type="file" id="import-file" accept=".json" style="display: none;">
    </div>

    <script>
        // Enhanced Event data structure with complete information
        const eventData = {
            'koi': {
                title: "üßä King of Icefield Calculator",
                items: {
                    'Fire Crystals': { points: 2000, available: true, toggle: 'fire-crystals' },
                    'Fire Crystal Shards': { points: 1000, available: true, toggle: 'fire-shards' },
                    '1 Minute of Speedups': { points: 30, available: true, toggle: 'speedups' },
                    'Mythic General Shards': { points: 3040, available: true, toggle: 'mythic-shards', minAmount: 5 },
                    'Hero Gear Essence Stone': { points: 4000, available: true, toggle: 'essence-stones' },
                    'Mithril': { points: 40000, available: true, toggle: 'mithril' }
                },
                troops: {
                    1: 3, 2: 4, 3: 5, 4: 8, 5: 12, 6: 18, 7: 25, 8: 35, 9: 45, 10: 60, 11: 75
                },
                toggles: [
                    { id: 'beast-26', label: 'Beast Level 26+', tooltip: 'Enable if your beast is level 26 or higher' }
                ],
                specialCalculations: {
                    beasts: { label: 'Beasts Killed', points: 1200, stamina: 10 },
                    polarTerror: { label: 'Polar Terror Rallies', points: 30000, stamina: 25 }
                }
            },
            'officer-essence': {
                title: "üßë‚Äç‚úàÔ∏è Officer Project - Essence Stone",
                items: {
                    'Hero Gear Essence Stone': { points: 6000, available: true, toggle: 'essence-stones' },
                    'Mithril': { points: 216000, available: true, toggle: 'mithril' },
                    'Mythic General Shards': { points: 3040, available: true, toggle: 'mythic-shards', minAmount: 5 },
                    'Advanced Wild Marks': { points: 15000, available: true, toggle: 'adv-marks' },
                    'Common Wild Marks': { points: 1150, available: true, toggle: 'common-marks' },
                    'Epic Hero Shards': { points: 1220, available: true, toggle: 'epic-shards', minAmount: 5 }
                },
                troops: {
                    1: 1, 2: 2, 3: 3, 4: 5, 5: 7, 6: 11, 7: 16, 8: 23, 9: 30, 10: 39, 11: 49
                },
                toggles: []
            },
            'officer-charm': {
                title: "üßë‚Äç‚úàÔ∏è Officer Project - Charm Designs",
                items: {
                    'Hero Gear Essence Stone': { points: 6000, available: true, toggle: 'essence-stones' },
                    'Mythic General Shards': { points: 3040, available: true, toggle: 'mythic-shards', minAmount: 5 },
                    'Epic Hero Shards': { points: 1220, available: true, toggle: 'epic-shards', minAmount: 5 }
                },
                troops: {
                    1: 1, 2: 2, 3: 3, 4: 4, 5: 6, 6: 9, 7: 12, 8: 17, 9: 22, 10: 30, 11: 37
                },
                toggles: []
            },
            'armament-tomes': {
                title: "üèπ Armament Competition - Two Tomes",
                items: {
                    'Fire Crystal': { points: 100, available: true, toggle: 'fire-crystals' },
                    'Refined Fire Crystal': { points: 1500, available: false, toggle: 'fc6' },
                    'Fire Crystal Shard (research)': { points: 50, available: false, toggle: 'state-age' },
                    'Mithril': { points: 28800, available: true, toggle: 'mithril' },
                    'Hero Gear Essence Stone': { points: 800, available: true, toggle: 'essence-stones' },
                    '1 Minute of Speedups': { points: 1, available: true, toggle: 'speedups' }
                },
                troops: {},
                toggles: [
                    { id: 'fc6', label: 'FC6+ Available', tooltip: 'Enable if you have Furnace Core level 6+' },
                    { id: 'state-age', label: 'State Age Research', tooltip: 'Enable if your state has research unlocked' }
                ]
            },
            'armament-design': {
                title: "üèπ Armament Competition - Design Plan",
                items: {
                    'Fire Crystal': { points: 100, available: true, toggle: 'fire-crystals' },
                    'Refined Fire Crystal': { points: 1500, available: false, toggle: 'fc6' },
                    'Fire Crystal Shard (research)': { points: 50, available: false, toggle: 'state-age' },
                    'Mithril': { points: 28800, available: true, toggle: 'mithril' },
                    'Hero Gear Essence Stone': { points: 800, available: true, toggle: 'essence-stones' },
                    '1 Minute of Speedups': { points: 1, available: true, toggle: 'speedups' }
                },
                troops: {},
                toggles: [
                    { id: 'fc6', label: 'FC6+ Available', tooltip: 'Enable if you have Furnace Core level 6+' },
                    { id: 'state-age', label: 'State Age Research', tooltip: 'Enable if your state has research unlocked' }
                ]
            },
            'svs': {
                title: "üè¥‚Äç‚ò†Ô∏è State vs State - Prep Phase",
                items: {
                    'Fire Crystal': { points: 2000, available: true, toggle: 'fire-crystals' },
                    'Fire Crystal Shard (research)': { points: 1000, available: true, toggle: 'fire-shards' },
                    'Refined Fire Crystal': { points: 30000, available: true, toggle: 'refined-crystals' },
                    '1 Minute of Speedups': { points: 30, available: true, toggle: 'speedups' },
                    'Epic Hero Shard': { points: 1220, available: true, toggle: 'epic-shards', minAmount: 5 },
                    'Mythic General Shard': { points: 3040, available: true, toggle: 'mythic-shards', minAmount: 5 },
                    '1 Stamina (Beast Lvl 26+ / PTR)': { points: 1200, available: false, toggle: 'beast-26' },
                    'Advanced Wild Marks': { points: 15000, available: true, toggle: 'adv-marks' },
                    'Common Wild Marks': { points: 1150, available: true, toggle: 'common-marks' },
                    'Hero Gear Essence Stone': { points: 4000, available: true, toggle: 'essence-stones' },
                    'Mithril': { points: 40000, available: true, toggle: 'mithril' }
                },
                troops: {
                    1: 1, 2: 2, 3: 3, 4: 4, 5: 6, 6: 9, 7: 12, 8: 17, 9: 22, 10: 30, 11: 37
                },
                toggles: [
                    { id: 'beast-26', label: 'Beast Level 26+', tooltip: 'Enable if your beast is level 26 or higher' }
                ]
            },
            'custom': {
                title: "‚öôÔ∏è Custom Event Calculator",
                items: {},
                troops: {},
                toggles: []
            }
        };

        // Current state
        let currentEvent = 'koi';
        let snipingEnabled = false;
        let troopsEnabled = false;
        let timerEnabled = false;
        let historyEnabled = false;
        let itemCounts = {};
        let toggleStates = {};
        let customEvents = {};
        let pointsHistory = [];
        let eventTimer = null;
        let advancedOptionsOpen = false;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadFromStorage();
            setupEventHandlers();
            renderCurrentEvent();
            calculateTotal();
            updateEventTabSelection();
        });

        function setupEventHandlers() {
            // Event tab handlers
            document.querySelectorAll('.event-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const event = this.dataset.event;
                    switchEvent(event);
                });
            });

            // Main toggles
            document.getElementById('sniping-toggle').addEventListener('click', function() {
                snipingEnabled = !snipingEnabled;
                this.classList.toggle('active', snipingEnabled);
                document.getElementById('sniping-section').style.display = snipingEnabled ? 'block' : 'none';
                saveToStorage();
            });

            document.getElementById('troops-toggle').addEventListener('click', function() {
                troopsEnabled = !troopsEnabled;
                this.classList.toggle('active', troopsEnabled);
                document.getElementById('troop-section').style.display = troopsEnabled ? 'block' : 'none';
                calculateTroops();
                saveToStorage();
            });

            document.getElementById('timer-toggle').addEventListener('click', function() {
                timerEnabled = !timerEnabled;
                this.classList.toggle('active', timerEnabled);
                document.getElementById('timer-section').style.display = timerEnabled ? 'block' : 'none';
                if (timerEnabled) {
                    startTimer();
                } else {
                    stopTimer();
                }
                saveToStorage();
            });

            document.getElementById('history-toggle').addEventListener('click', function() {
                historyEnabled = !historyEnabled;
                this.classList.toggle('active', historyEnabled);
                document.getElementById('history-section').style.display = historyEnabled ? 'block' : 'none';
                if (historyEnabled) {
                    renderHistory();
                }
                saveToStorage();
            });

            // Input handlers
            document.getElementById('target-gap').addEventListener('input', calculateSniping);
            document.getElementById('min-shards').addEventListener('change', calculateSniping);
            document.getElementById('event-end-time').addEventListener('change', startTimer);

            // Troop calculation inputs
            ['troop-level', 'troop-time', 'troop-speedups'].forEach(id => {
                document.getElementById(id).addEventListener('input', calculateTroops);
            });

            // File input handler
            document.getElementById('import-file').addEventListener('change', handleImportFile);
        }

        function updateEventTabSelection() {
            document.querySelectorAll('.event-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.event === currentEvent);
            });
        }

        function switchEvent(event) {
            // Save current points to history before switching
            if (currentEvent && currentEvent !== event) {
                savePointsToHistory();
            }

            currentEvent = event;
            updateEventTabSelection();

            // Show/hide custom event creator
            document.getElementById('custom-event-creator').style.display = 
                event === 'custom' ? 'block' : 'none';

            // Hide troops toggle for armament events
            const troopsToggleContainer = document.getElementById('troops-toggle-container');
            if (event === 'armament-tomes' || event === 'armament-design') {
                troopsToggleContainer.style.display = 'none';
                troopsEnabled = false;
                document.getElementById('troops-toggle').classList.remove('active');
                document.getElementById('troop-section').style.display = 'none';
            } else {
                troopsToggleContainer.style.display = 'flex';
            }

            renderCurrentEvent();
            calculateTotal();
            saveToStorage();
        }

        function toggleAdvancedOptions() {
            advancedOptionsOpen = !advancedOptionsOpen;
            const content = document.getElementById('advanced-content');
            const chevron = document.querySelector('.chevron');
            
            content.classList.toggle('active', advancedOptionsOpen);
            chevron.classList.toggle('rotated', advancedOptionsOpen);
        }

        function renderCurrentEvent() {
            const data = getCurrentEventData();
            
            // Update title
            document.getElementById('section-title').textContent = data.title;

            renderToggles();
            renderItems();
            renderSpecialCalculations();
            calculateTroops();
        }

        function getCurrentEventData() {
            if (currentEvent === 'custom' && customEvents[getCurrentCustomEventName()]) {
                return customEvents[getCurrentCustomEventName()];
            }
            return eventData[currentEvent];
        }

        function getCurrentCustomEventName() {
            return document.getElementById('custom-event-name')?.value || 'default';
        }

        function renderToggles() {
            const container = document.getElementById('toggles-container');
            container.innerHTML = '';

            const data = getCurrentEventData();
            const toggles = [...(data.toggles || [])];

            // Hide advanced options if no toggles
            const advancedOptions = document.getElementById('advanced-options');
            if (toggles.length === 0) {
                advancedOptions.style.display = 'none';
                return;
            } else {
                advancedOptions.style.display = 'block';
            }
            
            toggles.forEach(toggle => {
                const toggleContainer = document.createElement('div');
                toggleContainer.className = 'toggle-container';
                
                const toggleEl = document.createElement('div');
                const toggleKey = currentEvent + '-' + toggle.id;
                // Special toggles default to false
                const isActive = toggleStates[toggleKey] === true;
                toggleEl.className = `toggle ${isActive ? 'active' : ''}`;
                toggleEl.addEventListener('click', () => {
                    toggleStates[toggleKey] = !toggleStates[toggleKey];
                    toggleEl.classList.toggle('active', toggleStates[toggleKey]);
                    updateItemAvailability();
                    renderItems();
                    calculateTotal();
                    saveToStorage();
                });

                const label = document.createElement('label');
                label.className = 'tooltip';
                label.textContent = toggle.label;
                if (toggle.tooltip) {
                    label.setAttribute('data-tooltip', toggle.tooltip);
                }

                toggleContainer.appendChild(toggleEl);
                toggleContainer.appendChild(label);
                container.appendChild(toggleContainer);
            });
        }

        function updateItemAvailability() {
            const data = getCurrentEventData();
            Object.keys(data.items).forEach(itemName => {
                const item = data.items[itemName];
                if (item.toggle) {
                    const toggleKey = currentEvent + '-' + item.toggle;
                    // Special toggles default to false, others default to true
                    if (item.toggle === 'fc6' || item.toggle === 'state-age' || item.toggle === 'beast-26') {
                        item.available = toggleStates[toggleKey] === true;
                    } else {
                        item.available = toggleStates[toggleKey] !== false;
                    }
                }
            });
        }

        function renderItems() {
            const container = document.getElementById('items-container');
            container.innerHTML = '';

            const data = getCurrentEventData();
            updateItemAvailability();

            // Sort items by efficiency (points per unit) for better UX
            const sortedItems = Object.entries(data.items).sort((a, b) => a[1].points - b[1].points);

            sortedItems.forEach(([itemName, itemData]) => {
                const card = document.createElement('div');
                card.className = `item-card ${!itemData.available ? 'disabled' : ''}`;

                const header = document.createElement('div');
                header.className = 'item-header';

                const name = document.createElement('div');
                name.className = 'item-name';
                name.textContent = itemName;

                const pointsContainer = document.createElement('div');
                pointsContainer.style.textAlign = 'right';

                const points = document.createElement('div');
                points.className = 'item-points';
                points.textContent = `${itemData.points.toLocaleString()} pts`;

                // Add efficiency badge
                const efficiency = getEfficiencyBadge(itemData.points);
                if (efficiency) {
                    const badge = document.createElement('div');
                    badge.className = `efficiency-badge ${efficiency.class}`;
                    badge.textContent = efficiency.text;
                    pointsContainer.appendChild(badge);
                }

                pointsContainer.appendChild(points);

                const input = document.createElement('input');
                input.type = 'number';
                input.className = 'item-input';
                input.placeholder = itemData.minAmount ? `Min: ${itemData.minAmount}` : 'Enter quantity';
                input.min = itemData.minAmount || '0';
                input.step = itemData.minAmount || '1';
                const inputKey = currentEvent + '-' + itemName;
                input.value = itemCounts[inputKey] || '';
                input.disabled = !itemData.available;
                input.addEventListener('input', function() {
                    let value = parseInt(this.value) || 0;
                    if (itemData.minAmount && value > 0 && value < itemData.minAmount) {
                        value = Math.ceil(value / itemData.minAmount) * itemData.minAmount;
                        this.value = value;
                    }
                    itemCounts[inputKey] = value;
                    calculateTotal();
                    saveToStorage();
                });

                header.appendChild(name);
                header.appendChild(pointsContainer);
                card.appendChild(header);
                card.appendChild(input);
                container.appendChild(card);
            });
        }

        function getEfficiencyBadge(points) {
            if (points <= 100) return { text: 'Expensive', class: '' };
            if (points <= 1500) return { text: 'Medium', class: '' };
            if (points <= 10000) return { text: 'Better', class: 'medium' };
            return { text: 'Not Worth', class: 'low' };
        }

        function renderSpecialCalculations() {
            const container = document.getElementById('special-calculations');
            container.innerHTML = '';

            const data = getCurrentEventData();
            if (!data.specialCalculations) return;

            const section = document.createElement('div');
            section.className = 'special-inputs';
            
            const title = document.createElement('h4');
            title.textContent = 'üéØ Special Activities';
            section.appendChild(title);

            Object.entries(data.specialCalculations).forEach(([key, calc]) => {
                const inputGroup = document.createElement('div');
                inputGroup.className = 'input-group';
                inputGroup.style.marginBottom = '10px';

                const label = document.createElement('label');
                label.className = 'input-label';
                label.textContent = `${calc.label} (${calc.points.toLocaleString()} pts each, ${calc.stamina} stamina)`;

                const input = document.createElement('input');
                input.type = 'number';
                input.className = 'item-input';
                input.placeholder = 'Quantity completed';
                input.min = '0';
                const inputKey = currentEvent + '-special-' + key;
                input.value = itemCounts[inputKey] || '';
                input.addEventListener('input', function() {
                    itemCounts[inputKey] = parseInt(this.value) || 0;
                    calculateTotal();
                    saveToStorage();
                });

                inputGroup.appendChild(label);
                inputGroup.appendChild(input);
                section.appendChild(inputGroup);
            });

            container.appendChild(section);
        }

        function calculateTroops() {
            const container = document.getElementById('troop-calculation');
            container.innerHTML = '';

            if (!troopsEnabled) return;

            const data = getCurrentEventData();
            if (Object.keys(data.troops).length === 0) return;

            const level = parseInt(document.getElementById('troop-level').value);
            const timePerTroop = parseInt(document.getElementById('troop-time').value);
            const speedups = parseInt(document.getElementById('troop-speedups').value);

            if (!level || !timePerTroop || !speedups) {
                container.innerHTML = '<p style="color: var(--text-secondary);">Fill in all troop fields to see calculations.</p>';
                return;
            }

            const pointsPerTroop = data.troops[level];
            const maxTroops = Math.floor(speedups / timePerTroop);
            const totalPoints = maxTroops * pointsPerTroop;

            // Convert seconds to readable time
            const totalTime = maxTroops * timePerTroop;
            const hours = Math.floor(totalTime / 3600);
            const minutes = Math.floor((totalTime % 3600) / 60);
            const timeStr = hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m ${totalTime % 60}s`;

            container.innerHTML = `
                <div style="background: var(--bg-tertiary); padding: 15px; border-radius: 8px; border: 1px solid var(--border-color);">
                    <h4 style="color: var(--bright-blue); margin-bottom: 10px;">üìä Troop Training Analysis</h4>
                    <p><strong>Level ${level} Troops:</strong> ${pointsPerTroop} points each</p>
                    <p><strong>Max Troops You Can Train:</strong> ${maxTroops.toLocaleString()}</p>
                    <p><strong>Total Troop Points:</strong> <span style="color: var(--ice-blue); font-weight: bold;">${totalPoints.toLocaleString()}</span></p>
                    <p><strong>Time Required:</strong> ${timeStr}</p>
                </div>
            `;

            // Add to total calculation
            const troopKey = currentEvent + '-troop-total';
            itemCounts[troopKey] = totalPoints;
            calculateTotal();
        }

        function startTimer() {
            const endTimeInput = document.getElementById('event-end-time');
            if (!endTimeInput.value) return;

            const endTime = new Date(endTimeInput.value).getTime();
            const display = document.getElementById('timer-display');
            const progressBar = document.getElementById('progress-fill');

            // Clear existing timer
            if (eventTimer) clearInterval(eventTimer);

            // Set initial duration (7 days default)
            const totalDuration = 7 * 24 * 60 * 60 * 1000;

            eventTimer = setInterval(() => {
                const now = new Date().getTime();
                const timeLeft = endTime - now;

                if (timeLeft < 0) {
                    display.textContent = "Event Ended";
                    progressBar.style.width = '100%';
                    clearInterval(eventTimer);
                    showNotification("Event has ended!");
                    return;
                }

                const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
                const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);

                display.textContent = `${days}d ${hours}h ${minutes}m ${seconds}s`;
                
                // Calculate progress
                const elapsed = totalDuration - timeLeft;
                const progress = Math.min((elapsed / totalDuration) * 100, 100);
                progressBar.style.width = `${progress}%`;

                // Notification milestones
                if (timeLeft <= 3600000 && timeLeft > 3595000) { // 1 hour remaining
                    showNotification("‚è∞ Only 1 hour left in the event!");
                } else if (timeLeft <= 10800000 && timeLeft > 10795000) { // 3 hours remaining
                    showNotification("‚ö†Ô∏è 3 hours remaining in the event!");
                }
            }, 1000);
        }

        function stopTimer() {
            if (eventTimer) {
                clearInterval(eventTimer);
                eventTimer = null;
            }
        }

        function calculateTotal() {
            let total = 0;
            const data = getCurrentEventData();

            // Calculate item points
            Object.entries(data.items).forEach(([itemName, itemData]) => {
                if (itemData.available) {
                    const inputKey = currentEvent + '-' + itemName;
                    const quantity = itemCounts[inputKey] || 0;
                    total += quantity * itemData.points;
                }
            });

            // Calculate special activity points
            if (data.specialCalculations) {
                Object.entries(data.specialCalculations).forEach(([key, calc]) => {
                    const inputKey = currentEvent + '-special-' + key;
                    const quantity = itemCounts[inputKey] || 0;
                    total += quantity * calc.points;
                });
            }

            // Add troop points
            const troopKey = currentEvent + '-troop-total';
            total += itemCounts[troopKey] || 0;

            document.getElementById('total-points').textContent = total.toLocaleString();
        }

        function calculateSniping() {
            const targetGap = parseInt(document.getElementById('target-gap').value) || 0;
            const minShards = parseInt(document.getElementById('min-shards').value) || 1;
            const resultContainer = document.getElementById('sniping-result');

            if (targetGap <= 0) {
                resultContainer.innerHTML = '<p>Enter a target point gap to see recommendations.</p>';
                return;
            }

            const data = getCurrentEventData();
            const availableItems = Object.entries(data.items)
                .filter(([_, itemData]) => itemData.available)
                .sort((a, b) => a[1].points - b[1].points);

            let remainingGap = targetGap;
            const solution = [];

            for (const [itemName, itemData] of availableItems) {
                if (remainingGap <= 0) break;
                
                let needed = Math.ceil(remainingGap / itemData.points);
                
                if (itemData.minAmount && needed > 0) {
                    if (itemName.toLowerCase().includes('shard')) {
                        const userMin = Math.max(minShards, itemData.minAmount);
                        needed = Math.ceil(needed / userMin) * userMin;
                    } else {
                        needed = Math.ceil(needed / itemData.minAmount) * itemData.minAmount;
                    }
                }
                
                const maxSuggestion = itemData.points > 10000 ? 5 : (itemData.points > 1000 ? 20 : 100);
                
                if (needed <= maxSuggestion) {
                    const points = needed * itemData.points;
                    solution.push({
                        item: itemName,
                        quantity: needed,
                        points: points,
                        efficiency: itemData.points,
                        note: itemData.minAmount ? `(min: ${itemData.minAmount})` : ''
                    });
                    remainingGap -= points;
                }
            }

            if (solution.length > 0) {
                let html = '<h4>üí° Most Efficient Resource Combination:</h4><ul>';
                let runningTotal = 0;
                
                solution.forEach(item => {
                    runningTotal += item.points;
                    const efficiencyBadge = getEfficiencyBadge(item.efficiency);
                    html += `<li>
                        <strong>${item.quantity}x ${item.item}</strong> ${item.note} 
                        <span class="efficiency-badge ${efficiencyBadge.class}">${efficiencyBadge.text}</span>
                        = ${item.points.toLocaleString()} points
                    </li>`;
                });
                
                html += `</ul>
                    <div style="margin-top: 15px; padding: 10px; background: var(--bright-blue); color: white; border-radius: 6px;">
                        <strong>Total Points: ${runningTotal.toLocaleString()}</strong><br>
                        Target: ${targetGap.toLocaleString()}
                `;
                
                if (remainingGap < 0) {
                    html += `<br><span style="color: var(--ice-blue);">‚ú® Exceeds target by ${Math.abs(remainingGap).toLocaleString()} points</span>`;
                } else if (remainingGap > 0) {
                    html += `<br><span style="color: var(--ice-blue);">‚ö†Ô∏è Still need ${remainingGap.toLocaleString()} more points</span>`;
                }
                html += '</div>';
                
                resultContainer.innerHTML = html;
            } else {
                resultContainer.innerHTML = '<p>No suitable combination found. Try enabling more resources or lowering your target.</p>';
            }
        }

        // Points History Functions
        function savePointsToHistory() {
            const totalElement = document.getElementById('total-points');
            const total = parseInt(totalElement.textContent.replace(/,/g, '')) || 0;
            
            if (total > 0) {
                const historyEntry = {
                    event: currentEvent,
                    eventTitle: getCurrentEventData().title,
                    points: total,
                    timestamp: Date.now(),
                    date: new Date().toLocaleDateString()
                };
                
                pointsHistory.unshift(historyEntry);
                // Keep only last 20 entries
                pointsHistory = pointsHistory.slice(0, 20);
                saveToStorage();
            }
        }

        function renderHistory() {
            const container = document.getElementById('history-content');
            
            if (pointsHistory.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); margin-top: 15px;">No history yet. Switch between events to start tracking your points!</p>';
                return;
            }

            let html = '<div style="margin-top: 15px;">';
            pointsHistory.forEach((entry, index) => {
                const timeAgo = getTimeAgo(entry.timestamp);
                html += `
                    <div style="background: var(--bg-secondary); padding: 10px; border-radius: 6px; margin-bottom: 8px; border-left: 3px solid var(--bright-blue);">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span><strong>${entry.eventTitle}</strong></span>
                            <span style="color: var(--ice-blue); font-weight: bold;">${entry.points.toLocaleString()} pts</span>
                        </div>
                        <div style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 4px;">
                            ${entry.date} ‚Ä¢ ${timeAgo}
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            container.innerHTML = html;
        }

        function getTimeAgo(timestamp) {
            const now = Date.now();
            const diff = now - timestamp;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (days > 0) return `${days}d ago`;
            if (hours > 0) return `${hours}h ago`;
            if (minutes > 0) return `${minutes}m ago`;
            return 'Just now';
        }

        function clearHistory() {
            if (confirm('Are you sure you want to clear all points history?')) {
                pointsHistory = [];
                renderHistory();
                saveToStorage();
                showNotification('History cleared!');
            }
        }

        // Export/Import Functions
        function exportData() {
            const data = {
                currentEvent,
                itemCounts,
                toggleStates,
                customEvents,
                pointsHistory,
                exportDate: new Date().toISOString(),
                version: '2.0'
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `whiteout-calculator-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showNotification('Data exported successfully!');
        }

        function importData() {
            document.getElementById('import-file').click();
        }

        function handleImportFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (data.version) {
                        // Merge imported data
                        if (data.itemCounts) itemCounts = { ...itemCounts, ...data.itemCounts };
                        if (data.toggleStates) toggleStates = { ...toggleStates, ...data.toggleStates };
                        if (data.customEvents) customEvents = { ...customEvents, ...data.customEvents };
                        if (data.pointsHistory) pointsHistory = [...data.pointsHistory, ...pointsHistory].slice(0, 50);
                        
                        saveToStorage();
                        renderCurrentEvent();
                        calculateTotal();
                        if (historyEnabled) renderHistory();
                        
                        showNotification('Data imported successfully!');
                    } else {
                        throw new Error('Invalid file format');
                    }
                } catch (error) {
                    showNotification('Error importing file: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        // Notification system
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Show notification
            setTimeout(() => notification.classList.add('show'), 100);
            
            // Hide and remove notification
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => document.body.removeChild(notification), 300);
            }, 3000);
        }

        // Custom event functions
        function addCustomItem() {
            const itemName = document.getElementById('custom-item-name').value.trim();
            const itemPoints = parseInt(document.getElementById('custom-item-points').value);
            
            if (!itemName || !itemPoints) {
                alert('Please enter both item name and points');
                return;
            }

            const eventName = getCurrentCustomEventName() || 'Custom Event';
            
            if (!customEvents[eventName]) {
                customEvents[eventName] = {
                    title: `‚öôÔ∏è ${eventName}`,
                    items: {},
                    troops: {},
                    toggles: []
                };
            }

            customEvents[eventName].items[itemName] = {
                points: itemPoints,
                available: true
            };

            document.getElementById('custom-item-name').value = '';
            document.getElementById('custom-item-points').value = '';
            
            renderCustomItems();
            saveToStorage();
            showNotification('Item added successfully!');
        }

        function renderCustomItems() {
            const container = document.getElementById('custom-items-list');
            const eventName = getCurrentCustomEventName();
            
            if (!customEvents[eventName]) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = '';
            Object.entries(customEvents[eventName].items).forEach(([itemName, itemData]) => {
                const div = document.createElement('div');
                div.className = 'custom-item';
                div.innerHTML = `
                    <span style="flex: 1;"><strong>${itemName}</strong></span>
                    <span>${itemData.points.toLocaleString()} pts</span>
                    <button class="delete-btn" onclick="deleteCustomItem('${eventName}', '${itemName}')">Delete</button>
                `;
                container.appendChild(div);
            });
        }

        function deleteCustomItem(eventName, itemName) {
            if (customEvents[eventName] && customEvents[eventName].items[itemName]) {
                delete customEvents[eventName].items[itemName];
                renderCustomItems();
                if (currentEvent === 'custom') {
                    renderItems();
                    calculateTotal();
                }
                saveToStorage();
                showNotification('Item deleted!');
            }
        }

        function saveCustomEvent() {
            const eventName = getCurrentCustomEventName();
            if (!eventName) {
                alert('Please enter an event name');
                return;
            }

            renderCurrentEvent();
            calculateTotal();
            showNotification(`Custom event "${eventName}" saved successfully!`);
        }

        // Storage functions with improved error handling
        function saveToStorage() {
            const state = {
                currentEvent,
                snipingEnabled,
                troopsEnabled,
                timerEnabled,
                historyEnabled,
                itemCounts,
                toggleStates,
                customEvents,
                pointsHistory,
                advancedOptionsOpen,
                lastSaved: Date.now()
            };
            
            // Use regular variables instead of localStorage in Claude.ai environment
            try {
                // This will work in regular browsers
                if (typeof Storage !== "undefined") {
                    localStorage.setItem('whiteout-calculator', JSON.stringify(state));
                }
            } catch (e) {
                console.log('Storage not available, using memory only');
                // In Claude.ai, we'll just keep data in memory during the session
            }
        }

        function loadFromStorage() {
            try {
                if (typeof Storage !== "undefined") {
                    const saved = localStorage.getItem('whiteout-calculator');
                    if (saved) {
                        const state = JSON.parse(saved);
                        applyLoadedState(state);
                    }
                }
            } catch (e) {
                console.log('Could not load from storage, using defaults');
            }
        }

        function applyLoadedState(state) {
            currentEvent = state.currentEvent || 'koi';
            snipingEnabled = state.snipingEnabled || false;
            troopsEnabled = state.troopsEnabled || false;
            timerEnabled = state.timerEnabled || false;
            historyEnabled = state.historyEnabled || false;
            itemCounts = state.itemCounts || {};
            toggleStates = state.toggleStates || {};
            customEvents = state.customEvents || {};
            pointsHistory = state.pointsHistory || [];
            advancedOptionsOpen = state.advancedOptionsOpen || false;

            // Apply UI state
            document.getElementById('sniping-toggle').classList.toggle('active', snipingEnabled);
            document.getElementById('sniping-section').style.display = snipingEnabled ? 'block' : 'none';
            document.getElementById('troops-toggle').classList.toggle('active', troopsEnabled);
            document.getElementById('troop-section').style.display = troopsEnabled ? 'block' : 'none';
            document.getElementById('timer-toggle').classList.toggle('active', timerEnabled);
            document.getElementById('timer-section').style.display = timerEnabled ? 'block' : 'none';
            document.getElementById('history-toggle').classList.toggle('active', historyEnabled);
            document.getElementById('history-section').style.display = historyEnabled ? 'block' : 'none';

            if (advancedOptionsOpen) {
                setTimeout(() => toggleAdvancedOptions(), 100);
            }

            if (timerEnabled) {
                setTimeout(() => startTimer(), 100);
            }

            if (historyEnabled) {
                setTimeout(() => renderHistory(), 100);
            }
        }

        // Enhanced features
        function requestNotificationPermission() {
            if ("Notification" in window && Notification.permission !== "granted" && Notification.permission !== "denied") {
                Notification.requestPermission().then(function (permission) {
                    if (permission === "granted") {
                        showNotification("Notifications enabled! You'll be alerted about event milestones.");
                    }
                });
            }
        }

        function showBrowserNotification(title, body) {
            if ("Notification" in window && Notification.permission === "granted") {
                new Notification(title, {
                    body: body,
                    icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEyIDJMMTMuMDkgOC4yNkwyMCA5TDEzLjA5IDE1Ljc0TDEyIDIyTDEwLjkxIDE1Ljc0TDQgOUwxMC45MSA4LjI2TDEyIDJaIiBmaWxsPSIjMzI4MmI4Ii8+Cjwvc3ZnPgo='
                });
            }
        }

        // Performance tracking
        function trackEventPerformance() {
            const totalPoints = parseInt(document.getElementById('total-points').textContent.replace(/,/g, '')) || 0;
            
            if (totalPoints > 0) {
                const data = getCurrentEventData();
                const efficiency = calculateResourceEfficiency();
                
                return {
                    event: currentEvent,
                    totalPoints: totalPoints,
                    efficiency: efficiency,
                    timestamp: Date.now()
                };
            }
            return null;
        }

        function calculateResourceEfficiency() {
            const data = getCurrentEventData();
            let totalValue = 0;
            let totalItems = 0;
            
            Object.entries(data.items).forEach(([itemName, itemData]) => {
                if (itemData.available) {
                    const inputKey = currentEvent + '-' + itemName;
                    const quantity = itemCounts[inputKey] || 0;
                    if (quantity > 0) {
                        totalValue += quantity * itemData.points;
                        totalItems += quantity;
                    }
                }
            });
            
            return totalItems > 0 ? totalValue / totalItems : 0;
        }

        // Auto-save every 30 seconds
        setInterval(() => {
            if (typeof saveToStorage === 'function') {
                saveToStorage();
            }
        }, 30000);

        // Save when page is about to close
        window.addEventListener('beforeunload', function() {
            saveToStorage();
            savePointsToHistory();
        });

        // Initialize notification permission request
        setTimeout(requestNotificationPermission, 2000);

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 's':
                        e.preventDefault();
                        saveToStorage();
                        showNotification('Data saved!');
                        break;
                    case 'e':
                        e.preventDefault();
                        exportData();
                        break;
                    case 'i':
                        e.preventDefault();
                        importData();
                        break;
                }
            }
        });

        // Add version info for debugging
        console.log('Whiteout Survival Calculator v2.0 Enhanced');
        console.log('Features: Event Timer, Points History, Export/Import, Notifications');
    </script>
</body>
</html>
